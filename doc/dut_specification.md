# Описание DUT

АЛУ для операций над матрицами.

Варианты операций: перемножение, сложение, транспонирование, вычисление обратной матрицы, вычисление определителя.

## **Параметры**

| Название     | Значение по умолчанию | Допустимый диапазон | Описание                                                   |
| :----------- | :-------------------- | :------------------ | :--------------------------------------------------------- |
| AXI_DATA_W   | 8                     | 2..64               | Разрядность шины данных AXI                                |
| BUFFER_DEPTH | 64                    | 16..512             | Размер буфера (в количестве элементов) для хранения матриц |

В процессе верификации параметры дизайна будут принимать значения по умолчанию.

## **Описание входных и выходных сигналов DUT**

![](img/photo1.svg)



| Название                                                     | Направление | Разрядность | Описание                                                     |
| :----------------------------------------------------------- | :---------- | :---------- | :----------------------------------------------------------- |
| `clk_i`                                                      | I           | 1           | Тактовый сигнал. Весь блок работает в одном тактовом домене. |
| `resetn_i`                                                   | I           | 1           | Асинхронный сигнал сброса. Активный уровень – низкий.        |
| `irq_o`                                                      | O           | 1           | Сигнал прерывания. Активный уровень – высокий.               |
| **AXI Stream IN<br />Интерфейс для передачи матриц-операндов** |             |             |                                                              |
| `axis_data_i`                                                | I           | AXI_DATA_W  | Шина передачи данных **(signed)**                            |
| `axis_valid_i`                                               | I           | 1           | Сигнал валидности данных на шине `axis_data_i`               |
| `axis_ready_o`                                               | O           | 1           | Сигнал готовности slave к приёму данных по шине `axis_data_i` |
| `axis_last_i`                                                | I           | 1           | Сигнал от master, маркирующий завершение пакета передаваемых данных |
| **AXI Stream OUT<br />Интерфейс для передачи результирующих матриц** |             |             |                                                              |
| `axis_data_o`                                                | O           | AXI_DATA_W  | Шина передачи данных **(signed)**                            |
| `axis_valid_o`                                               | O           | 1           | Сигнал валидности данных на шине `axis_data_o`               |
| `axis_ready_i`                                               | I           | 1           | Сигнал готовности master к приёму данных по шине `axis_data_o` |
| `axis_last_o`                                                | O           | 1           | Сигнал от slave, маркирующий завершение пакета передаваемых данных |
| **APB<br />Интерфейс для доступа к регистрам устройства**    |             |             |                                                              |
| `paddr_i`                                                    | I           | 32          | Шина адреса                                                  |
| `pwdata_i`                                                   | I           | 32          | Шина данных от master к slave                                |
| `prdata_o`                                                   | O           | 32          | Шина данных от slave к master                                |
| `penable_i`                                                  | I           | 1           | Сигнал, маркирующий наличие активного запроса от master к slave |
| `pready_o`                                                   | O           | 1           | Сигнал, маркирующий предоставление ответа на запрос от slave к master |
| `pwrite_i`                                                   | I           | 1           | Сигнал, маркирующий тип запроса от master к slave (запись/чтение) |
| `pslverr_o`                                                  | O           | 1           | Сигнал, маркирующий статус выполнения запроса:<br />0 – выполнено успешно<br />1 – произошла ошибка |

## **Описание работы**

#### **Протокольный уровень передачи данных**

Операция, выполняемая над матрицами, а также их размеры устанавливаются через конфигурационные регистры. Конфигурация передается по APB подобному протоколу ([Описание протокола](#apb-подобный-протокол)).

Ниже приведён пример записи и чтения конфигурационных регистров:



![](img/photo2.svg)

<br />

Матрицы передаются устройству по AXI4-Stream протоколу ([Описание протокола](#axi4-stream-протокол)). Одна матрица передаётся целиком в рамках одного пакета. Дешифровка матрицы из пакета производится с учётом значений из регистров `MATRIX0V`, `MATRIX0H`, `MATRIX1V`,  `MATRIX1H`.

Ниже приведён пример кодирования матрицы при конфигурационных регистрах `MATRIX0V` = 0x2, `MATRIX0H` = 0x3:

<br />

![](img/photo3.svg)

<br />

Ниже приведён пример кодирования матрицы при конфигурационных регистрах `MATRIX0V` = 0x2, `MATRIX0H` = 0x2. **Количество переданных элементов каждой матрицы может превышать число элементов, рассчитываемое из значений конфигурационных регистров размеров этой матрицы. Общее количество переданных элементов двух матриц не должно превышать глубину буфера, являющегося памятью.**

<br />

![](img/photo4.svg)

<br />

Для выполнения операций над двумя матрицами-операндами пользователю следует передать их последовательно в виде двух отдельных пакетов.

Результирующая матрица передается по AXI4-Stream протоколу в рамках одного пакета. Один элемент результирующей матрицы передается в виде двух data-стробов, первый - является старшей частью, второй - младшей.

Ниже приведен пример кодирования результата матрицы 2x2:

<br />

![](img/photo5.svg)

<br />

#### Описание автомата состояния устройства



![](img/photo6.svg)<br />

| Состояние        | Описание                                                     |
| ---------------- | ------------------------------------------------------------ |
| **IDLE**         | Переход в данное состояние возможен из любого возможного состояния устройства при активном сигнале `resetn_i`.<br /><br />В данном состоянии мастер имеет доступ на **запись**/чтение конфигурационных регистров, также недоступна инициализация матриц - устройство не будет принимать данные по AXI-stream протоколу (сигнал готовности `axis_ready_o` = 0).<br /><br />Переход в состояния:<br /><br />**INIT_MATRIX0** - по факту **записи** в конфигурационный регистр `OPCODE` значения 0x1 или 0x2 или 0x3 или 0x4 или 0x5. |
| **INIT_MATRIX0** | Устройство (готово принимать/принимает) данные для буфера первой матрицы (сигнал готовности `axis_ready_o` = 1).<br /><br />После инициализации первой матрицы возможны переходы в состояния:<br /><br />**ERROR** - буфер хранения матриц переполнился (проверка осуществляется по факту приема последнего элемента матрицы, `axis_last_i` = 1).<br />**INIT_MATRIX1** - регистр конфигурации `OPCODE` = 0x1 (сложение) или 0x2 (перемножение). <br />**CALC** - регистр конфигурации `OPCODE` = 0x3 (транспонирование) или 0x4 (вычисление обратной матрицы) или 0x5 (вычисление определителя).<br /><br />В данном состоянии мастер не имеет доступ на запись к конфигурационным регистрам, но имеет доступ на их чтение. При попытке записи в конфигурационный регистр устройство ответит ошибкой (`pslv_err_o` = 1). |
| **INIT_MATRIX1** | Устройство (готово принимать/принимает) данные для буфера второй матрицы (сигнал готовности `axis_ready_o` = 1).<br /><br />Переход в состояния:<br /><br />**ERROR** - буфер хранения матриц переполнился (проверка осуществляется по факту приема последнего элемента матрицы, `axis_last_i` = 1). <br />**CALC** - при окончании приема второй матрицы.<br /><br />В данном состоянии мастер не имеет доступ на запись к конфигурационным регистрам, но имеет доступ на их чтение. При попытке записи в конфигурационный регистр устройство ответит ошибкой (`pslv_err_o` = 1). |
| **CALC**         | Устройство анализирует конфигурационные регистры, на их основе формирует матрицы из приемных буферов и выполняет/не выполняет соответствующие операции.<br /><br />Переход в состояния:<br /><br />**ERROR**:<br />- при несоблюдении размеров матрицы/матриц для соответствующей операции, либо размеров буфера;<br />- данные в матрице не пригодны для соответствующей операции. <br />**RESULT READY** - при успешной операции.<br /><br />Время выполнения операций c переходом в состояние **ERROR** - 1 такт, в состояние **RESULT READY** - 3 такта.<br />В данном состоянии мастер не имеет доступ на запись к конфигурационным регистрам, но имеет доступ на их чтение. При попытке записи в конфигурационный регистр устройство ответит ошибкой (`pslv_err_o` = 1). Также недоступна инициализация матриц - устройство не будет принимать данные по AXI stream протоколу (сигнал готовности `axis_ready_o` = 0). |
| **RESULT READY** | Устройство сигнализирует об успешном окончании вычислений, выставляя прерывание на сигнал `irq_o` в соответствии с регистром `IER[1]`, а также записывает в конфигурационный регистр `ISR[1]` соответствующее значение и инкрементирует конфигурационный регистр-счетчик заданной операции.<br /><br />Переход в состояния:<br /><br />**WRITE RESULT** - при выходе из прерывания, записи единицы в регистр `ISR[1]`.<br /><br />Время выполнения операции - 1 такт, после записи в регистр `ISR[1]`.<br />В данном состоянии мастер имеет доступ на запись/чтение конфигурационных регистров, но недоступна инициализация матриц - устройство не будет принимать данные по AXI stream протоколу (сигнал готовности `axis_ready_o` = 0). |
| **WRITE RESULT** | Устройство ожидает готовность мастера принять результат операций. При готовности мастера (`axis_ready_i` = 1) выдается результат на шину `axis_data_o` в рамках одного пакета.<br /><br />Переход в состояния:<br /><br />**MASS ERASE** - при доставке полного пакета результата мастеру.<br /><br />Время выполнения операции определяется с учетом готовности мастера. Передача одного элемента матрицы устройством составляет 1 такт.<br />В данном состоянии мастер не имеет доступ на запись к конфигурационным регистрам, но имеет доступ на их чтение. При попытке записи в конфигурационный регистр, устройство ответит ошибкой (`pslv_err_o` = 1), также недоступна инициализация матриц - устройство не будет принимать данные по AXI stream протоколу (сигнал готовности `axis_ready_o` = 0). |
| **MASS ERASE**   | Устройство очищает приемный буфер.<br /><br />Переход в состояния:<br /><br />**IDLE** - по завершении стирания приемного буфера и регистра `STATUS`.<br /><br />Время выполнения операции - 1 такт, т.е в состоянии IDLE гарантируются очищенные буфер приема и сброшенный регистр `STATUS`.<br />В данном состоянии мастер не имеет доступ на запись к конфигурационным регистрам, но имеет доступ на их чтение. При попытке записи в конфигурационный регистр, устройство ответит ошибкой (`pslv_err_o` = 1), также недоступна инициализация матриц - устройство не будет принимать данные по AXI stream протоколу (сигнал готовности `axis_ready_o` = 0). |
| **ERROR**        | Устройство сигнализирует об ошибке, выставляя прерывание на сигнал `irq_o` в соответствии с регистром `IER[0]`, а также записывает в конфигурационный регистр `ISR[0]` соответствующее значение.<br /><br />Переход в состояния:<br /><br />**MASS ERASE** - при выходе из прерывания, записи единицы в регистр `ISR[0]`.<br /><br />Время выполнения операции  - 1 такт, после записи в регистр `ISR[0]`.<br />В данном состоянии мастер имеет доступ на запись/чтение конфигурационных регистров, но недоступна инициализация матриц - устройство не будет принимать данные по AXI stream протоколу (сигнал готовности `axis_ready_o` = 0). |

*Исходя из описания автомата состояния, процедуру программирования следует выполнять в следующем порядке:*

1) Подача тактового сигнала на устройство;
2) Сброс устройства;
3) Программирование конфигурационных регистров устройства в последовательности - размер, операция.
4) Запись в буфер матриц;
5) При прерывании по ошибке - сбросить прерывание, убедиться в корректности программирования конфигурационных регистров / данных в матрице, повторить с пункта 3. При прерывании по окончанию вычислений - сбросить прерывание, перейти к пункту 6.
6) Ожидание выдачи результата , прием результата;
7) Повторить пункты 3-5.

## **Ограничения**

Для операций вычисления обратной матрицы и определителя максимальный допустимый размер матрицы - **8x8**.

Адрес APB должен быть выровнен относительно границы слова данных. Это значит, что адрес данных должен быть кратен размеру слова в байтах. В данном случае размер слова равен 4 байтам (32 бита). Соответственно, адреса должны быть кратны 4. 
Например, 0х04 - выровненный адрес, а 0х07 - нет.

## **Карта конфигурационных регистров**

| Регистр    | Смещение | Размер  | Тип доступа | Описание                                                     | Значение по сбросу |
| :--------- | :------- | :------ | :---------- | :----------------------------------------------------------- | :----------------- |
| `OPCODE`   | 0x0      | 32 бита | RW          | Задание операции, применяемой вычислителем к переданным данным:<br />0x0 - нет операции (bypass);<br />0x1 - сложение;<br />0x2 - перемножение;<br />0x3 - транспонирование;<br />0x4 - вычисление обратной матрицы;<br />0x5 - вычисление определителя. | 0x0                |
| `STATUS`   | 0x4      | 32 бита | RO          | Бит[0] - Состояние буфера для хранения матриц-операндов:<br />0x0 - буфер для хранения матриц пуст(бит сбрасывается аппаратно по завершении **MASS ERASE**);<br />0x1  - буфер для хранения матриц не пуст(бит становится активным при получении одного элемента матрицы).<br /><br />Бит[1] - Флаг окончания вычисления:<br />0x0 - Результат не готов (бит сбрасывается аппаратно по завершении **MASS ERASE**);<br />0x1  - Результат готов и устройство в ожидании готовности приема данных мастером FSM в состоянии **WRITE RESULT**. | 0x0                |
| `ISR`      | 0x8      | 32 бита | RW1C        | Бит[0] - прерывание по ошибке:<br />0x0 - Нет прерывания;<br />0x1 - Ошибка, вычисление невозможно. <br />Запись единицы в нулевой бит снимает прерывание. <br /><br />Бит[1] - прерывание по окончанию вычислений:<br />0x0 - Нет прерывания;<br />0x1 - Вычисление окончено. <br />Запись единицы снимает прерывание.<br />Биты [31:2] - зарезервированы | 0x0                |
| `IER`      | 0xC      | 32 бита | RW          | Маскирующий бит[0] - прерывание по ошибке:<br />0x0 - сигнал irq_o=1 в состоянии ERROR;<br />0x1 - сигнал irq_o=0 в состоянии ERROR.<br /><br />Маскирующий бит[1] - прерывание окончанию вычислений:<br />0x0 - сигнал irq_o=1 в состоянии RESULT READY;<br />0x1 - сигнал irq_o=0 в состоянии RESULT READY.<br />Биты [31:2] - зарезервированы | 0x0                |
| `MATRIX0V` | 0x10     | 32 бита | RW          | Размерность матрицы-операнда 0 по вертикали. <br />*Диапазон неограничен, но его корректность проверяется в автомате состояния. Рекомендуется выбирать исходя из параметра **BUFFER_DEPTH** , размеров второй матрицы, а также opcode.* | 0x0                |
| `MATRIX0H` | 0x14     | 32 бита | RW          | Размерность матрицы-операнда 0 по горизонтали.<br />*Диапазон неограничен, но его корректность проверяется в автомате состояния. Рекомендуется выбирать исходя из параметра **BUFFER_DEPTH**, размеров второй матрицы, а также opcode.* | 0x0                |
| `MATRIX1V` | 0x18     | 32 бита | RW          | Размерность матрицы-операнда 1 по вертикали.<br />*Диапазон неограничен, но его корректность проверяется в автомате состояния. Рекомендуется выбирать исходя из параметра **BUFFER_DEPTH**, размеров первой матрицы, а также opcode.* | 0x0                |
| `MATRIX1H` | 0x1C     | 32 бита | RW          | Размерность матрицы-операнда 1 по горизонтали. <br />*Диапазон неограничен, но его корректность проверяется в автомате состояния. Рекомендуется выбирать исходя из параметра **BUFFER_DEPTH**, размеров первой матрицы, а также opcode.* | 0x0                |
| `SUM CTR`  | 0x20     | 32 бита | RO          | Счётчик операций сложения                                    | 0x0                |
| `MULT CTR` | 0x24     | 32 бита | RO          | Счётчик операций умножения                                   | 0x0                |
| `TRAN CTR` | 0x28     | 32 бита | RO          | Счётчик операций транспонирования                            | 0x0                |
| `REV CTR`  | 0x2C     | 32 бита | RO          | Счётчик операций вычисления обратной матрицы                 | 0x0                |
| `DET CTR`  | 0x30     | 32 бита | RO          | Счётчик операций вычисления определителя                     | 0x0                |

При попытке доступа за пределы адресного пространства на шину APB выдаётся `pslverr_o` = 1, сигнализирующий об ошибке.



## **AXI4-stream протокол**

Потоковая передача — это способ передачи данных из одного блока в другой. Идея потоковых устройств заключается в обеспечении постоянного потока высокоскоростных данных, поэтому обычно каждый тактовый импульс передает один новый блок данных. Кроме того, для снижения накладных расходов потоковые шины не имеют адресации. Потоковые соединения являются двухточечными, поэтому адресация не требуется.

Одним из примеров потоковых интерфейсов является интерфейс AXI4-Stream ([Спецификация протокола](https://zipcpu.com/doc/axi-stream.pdf)). Он обладает высокой степенью гибкости, имеет некоторые обязательные сигналы и множество дополнительных.

Сигналы, которые используются в дизайне:

- `CLK` – тактовый сигнал (потоковая шина AXI синхронна);

- `DATA` – шина данных;

- `READY` и `VALID` – сигналы управления потоком данных;

- `LAST` - сигнал признака окончания передачи пакета.

  <br />

![](img/photo11.svg)

<br />

Первая транзакция состоит из четырех циклов данных, от D0 до D3. Последний цикл данных отмечается активным стробом сигнала `LAST`. Обратите внимание, что во время транзакции значения `VALID` и `READY` всегда высокие. Вторая транзакция имеет n циклов данных.

`VALID` и `READY` используются для управления потоком данных. Если у передатчика больше нет данных для отправки, сигнал VALID становится низким. Аналогичным образом, когда принимающая сторона потока AXI не готова принимать дополнительные данные, она отменяет подтверждение сигнала готовности (`READY` переходит в 0).

На рисунке ниже показан сценарий, в котором переключаются как `READY`, так и `VALID` сигналы. Новые данные могут появиться на шине только в том случае, если `VALID` и `READY` были подтверждены на предыдущем такте.

<br />

![](img/photo12.svg)

<br />

Для данных «P0» `VALID` и `READY` подтверждаются вместе только в 5 такте, поэтому в 6 такте могут быть выведены новые данные «P1». Для передачи «P3» также требуется три такта, поскольку в такте 8 подтверждение `VALID` снимается, а в такте 9 `READY` снимается. В такт 10 оба утверждаются, поэтому в такт 11 новые данные (не показаны) передаются на шину ведущим устройством.



## **APB подобный протокол**

APB подобный протокол основан на протоколе передачи стандарта APB3 ([Спецификация](https://web.eecs.umich.edu/~prabal/teaching/eecs373-f12/readings/ARM_AMBA3_APB.pdf)). Его отличие заключается в отсутствии сигнала `PSEL`, который предназначается для управления адресацией трафика между мастером и множеством слейвов. В матричном калькуляторе слейв всего один, поэтому данный сигнал решено было не использовать. 

Диаграммы передачи транзакций без использования управляющего сигнала `PSEL` представлены ниже:

1. Транзакция записи без задержки сигнала готовности слейва `PREADY`:

   <br />

![](img/photo7.svg)



2. Транзакция записи с задержкой сигнала готовности слейва `PREADY`:

   <br />

![](img/photo8.svg)

3. Транзакция чтения без задержки сигнала готовности слейва `PREADY`:

   <br />

   ![](img/photo9.svg)

   

4. Транзакция чтения с задержкой сигнала готовности слейва `PREADY`:

   <br />

   ![](img/photo10.svg)